<!doctype html>
<html>
<head>
<title>Microblog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="microblog.css" />
</head>
<body>
  <div id="timeline"></div>

  <div id="new_post">
    <form>
      <label for="text_post_message">140</label>
      <textarea rows="2" id="text_post_message" name="new_post_text"></textarea>
      <button>send</button>
    </form>
  </div>

  <script>
    var users = {
      '1': {
        username: 'marymeeker',
        real_name: 'Mary Meeker',
        verified: true
      },
      '2': {
        username: 'ConanOBrien',
        real_name: 'Conan O\' Brien',
        verified: true
      },
      '3': {
        username: 'baratunde',
        real_name: 'Baratunde',
        verified: false
      }
    };

    var posts = [
      {
        id: 2374237842,
        user: 1,
        message: 'Spotify has grown to more than 60 million monthly active users, 15 million of whom are paying subscribers.',
        ts: 1337774582
      },
      {
        id: 2374272076,
        user: 2,
        message: 'If I were in prison, I wouldn\'t ruin my spoon trying to tunnel out, because going without morning yogurt is its own prison.',
        ts: 1337968739
      },
      {
        id: 4545435344,
        user: 3,
        message: 'Something beautiful for you from Cornwall.',
        photos: ['cornwall.jpg'],
        ts: 1461607139
      },
      {
        id: 4629293242,
        user: 2,
        reply_to: 4545435344,
        message: 'Love this shot. Reminds me of the first time someone found me at the end of a rainbow holding a pot of gold.',
        ts: 1478942943
      }
    ];
    
    function timeSince(ts) {
      var now = new Date(),
          timeStamp = new Date(ts * 1000),
          secondsPast = (now.getTime() - timeStamp.getTime()) / 1000;
      
      if (secondsPast < 60) {
        return parseInt(secondsPast) + 's';
      }

      if (secondsPast < 3600) {
        return parseInt(secondsPast / 60) + 'm';
      }

      if (secondsPast <= 86400) {
        return parseInt(secondsPast / 3600) + 'h';
      }

      if (secondsPast > 86400) {
        day = timeStamp.getDate();
        month = timeStamp.toDateString().match(/ [a-zA-Z]*/)[0].replace(" ", "");
        year = timeStamp.getFullYear() == now.getFullYear() ? "" : " " + timeStamp.getFullYear();
        return day + " " + month + year;
      }
    }

    function insertPhotos(photoArray) {
      var html = '';
      
      if (photoArray && photoArray.length > 0) {
        for (var i = 0; i < photoArray.length; i++) {
          html += '<img src="' + photoArray[i] + '"/>';
        }
      }

      return html;
    }

    function postIt(post, newPost) {
      var frag = document.createDocumentFragment();
      var el = document.createElement('div');
      var tsYear = new Date(post.ts).getFullYear() + 'y';
      var tsDate = new Date(post.ts).getDate() + 'd';
      var tsHours = new Date(post.ts).getHours() + 'h';
      var replyTo;

      el.setAttribute('data-id', post.id);
      el.classList.add('post');

      /* 
      *  - Using this hack since I don't know how to reference the user account image
      *    since there is no true reference in data objects
      *  - static images renamed to usernames to be able to use
      */
      if (newPost) {
        el.innerHTML += '<div class="post-user--avatar"><img src="' + users[post.user].username + '.svg" /></div>';
      } else {
        el.innerHTML += '<div class="post-user--avatar"><img src="' + users[post.user].username + '.jpg" /></div>';
      }

      el.innerHTML +=
      '<div class="post-user--posted">' +
        '<div class="post-user--posted_info">' +
          '<i class="material-icons" data-verified="' + users[post.user].verified + '">verified_user</i>' +
          '<user data-realname="' + users[post.user].real_name + '" data-username="' + users[post.user].username + '"></user>' +
          '<span data-ts="' + post.ts + '" class="post-user--posted_info-timestamp">' + timeSince(post.ts) + '</span>' +
        '</div>' +
        '<div class="post-user--posted_message">' +
          '<q>' + post.message + '</q>' +
          '<div class="post-user--posted_message-photos">' + insertPhotos(post.photos) + '</div>' +
          '<cite>' + post.user + '</cite>' +
          '<ul class="post-user--posted_message-social">' +
            '<li>' +
              '<input type="button" class="material-icons" data-id="' + post.id + '" value="reply">' +
              '<input type="button" class="material-icons" data-id="' + post.id + '" value="repeat">' +
              '<input type="button" class="material-icons" data-id="' + post.id + '" value="favorite">' +
            '</li>' +
            '<li>' +
              '<span data-type="reply">0</span>' +
              '<span data-type="repeat">0</span>' +
              '<span data-type="favorite">0</span>' +
            '</li>' +
          '</ul>' +
        '</div>' + 
        '<div class="post-user--posted_message-replies"></div>' +
      '</div>';

      if (typeof post.reply_to !== 'undefined' && post.reply_to !== null) {
        replyTo = document.querySelector('[data-id="' + post.reply_to + '"] .post-user--posted_message-replies');
        frag.appendChild(el);
        replyTo.appendChild(frag);
      } else {
        frag.appendChild(el);
        timeline.appendChild(frag);
      }

      if (newPost) {
        el.classList.add('loggedin-user');
        el.classList.add('latest-post');

        setTimeout(function () {
          el.classList.add('fade-in');
        }, 50);
      }

      window.lastPostId = post.id; // used to increment to the next post ID
      window.scrollTo(0, document.querySelector('[data-id="' + post.id + '"]').getBoundingClientRect().top);
    }

    function createPosts() {
      var post;
      
      for (var i = 0; i < posts.length; i++) {
        post = posts[i];
        postIt(post, false);
      }
    }

    function bindEvents() {
      var newPost = document.getElementById('new_post');
      var message = newPost.querySelector('textarea[id="text_post_message"]');
      var postBtn = newPost.querySelector('button');
      var limitLbl = newPost.querySelector('label[for="text_post_message"]');

      function resetLatestPost() {
        var latest = document.querySelectorAll('.latest-post');

        for (let i=0; i < latest.length; i++) {
          latest[i].classList.remove('latest-post');
          latest[i].classList.remove('fade-in');
        }
      }

      function updatePostTimes() {
        var timeline = document.getElementById('timeline');
        var postArr = timeline.querySelectorAll('.post');
        var postTimestamp;
        var timestamp;

        for (let i = 0; i < postArr.length; i++) {
          postTimestamp = postArr[i].querySelector('.post-user--posted_info-timestamp');
          timestamp = parseInt(postTimestamp.getAttribute('data-ts'));
          postTimestamp.innerHTML = timeSince(timestamp);
        }
      }

      function textAreaHandler() {
        var length = this.value.length;
        var charsRemaining = 140 - length;

        if (length > 140) {
          limitLbl.classList.add('warning');
        } else {
          limitLbl.classList.remove('warning');
        }

        limitLbl.innerHTML = charsRemaining;
      }

      postBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        var now = new Date();
        var timestamp =  now.getTime() / 1000;
        var photos = [];

        if (message.value.length <= 140) {
          posts.push({
            id: parseInt(window.lastPostId) + 1,
            user: 4,
            photos: photos,
            message: message.value,
            ts: timestamp
          });

          resetLatestPost();
          updatePostTimes();
          postIt(posts[posts.length-1], true);
          message.value = '';
          limitLbl.innerHTML = '140';
        } else {
          alert('Message is limited to 140 characters.');
        }
      });

      message.addEventListener('keypress', textAreaHandler, true);
    }

    (function() {
      // On load, this is the user logged in.
      users['4'] = {
        username: 'bettermortgage',
        real_name: 'Better Mortgage',
        verified: true
      };

      // Define the current user who is logged in
      window.currentUser = users['4'].username;
      
      // Load pre-existing posts
      createPosts();

      // Bind events to new post form and post replies
      bindEvents();
    })();
  </script>
  </body>

</html>